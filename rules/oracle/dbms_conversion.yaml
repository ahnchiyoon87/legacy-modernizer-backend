name: "PostgreSQL → Oracle PL/SQL 변환"
description: "PostgreSQL 본문 로직을 Oracle PL/SQL 본문 로직으로 정확히 변환"
version: "8.2"

path: "../dbms/{project_name}/{folder_name}"

input_schema:
  required:
    - code
    - locale
  optional:
    parent_code:
      default: ""
      description: "참고용 컨텍스트 (출력에는 포함 금지)"

prompt: |
  =====================================================================
  입력 규칙
  =====================================================================
  - {{code}}: PostgreSQL 본문 로직 전체
  - {{parent_code}}: 참고용 컨텍스트 (출력에 절대 포함하지 않음)

  변환 대상은 오직 {{code}} 내부 로직이며,
  출력에는 Oracle PL/SQL 본문 로직만 포함한다.

  =====================================================================
  최우선 목표
  =====================================================================
  1. PostgreSQL과 Oracle의 실행 결과가 100% 동일하게 유지될 것
  2. Oracle 12c+ 환경에서 문법 오류 없이 컴파일될 것
  3. 변수명, 테이블명, 컬럼명 등 비즈니스 의미 요소는 절대 변경하지 않는다
  4. 억지로 스타일을 맞추려고 하지 마세요. 컴파일 오류 발생하지 않도록 하세요.
  5. 컴파일 오류 없이, 원본 코드와 결과만 100% 동일하면 됩니다.

  =====================================================================
  전환 기본 규칙
  =====================================================================
  - 출력은 **Oracle PL/SQL 본문 로직만** 생성한다.
  - parent_code 내용은 읽기만 하고 출력에 포함하지 않는다.
  - JSON 최종 출력 형식:
      {"code": "Oracle PL/SQL 본문 전체"}

  =====================================================================
  SELECT / LIMIT / OFFSET / DISTINCT ON
  =====================================================================
  - LIMIT/OFFSET → OFFSET … ROWS FETCH FIRST … ROWS ONLY
  - DISTINCT ON → ROW_NUMBER() OVER(PARTITION BY … ORDER BY …)
  - LIKE/ILIKE 변환:
      - ILIKE → UPPER(col) LIKE UPPER(pattern)
  - 서브쿼리에는 반드시 별칭 부여
      FROM (SELECT ...) t

  =====================================================================
  INSERT / RETURNING / ON CONFLICT
  =====================================================================
  - PostgreSQL RETURNING → Oracle RETURNING INTO
  - ON CONFLICT → MERGE INTO … USING (…) ON (…) WHEN MATCHED / NOT MATCHED
  - USING 절의 SELECT 서브쿼리는 괄호로 감싸고 별칭 필수

  =====================================================================
  UPDATE / DELETE / FROM / USING
  =====================================================================
  - UPDATE … FROM … → MERGE 또는 서브쿼리 UPDATE로 변환
  - DELETE … USING → DELETE … WHERE EXISTS (…) 로 변환
  - CTE(WITH)는 Oracle 12c+에서 동일하게 사용 가능

  =====================================================================
  WITH (CTE)
  =====================================================================
  - WITH c AS (SELECT …)
    SELECT … FROM c;
  - UPDATE/DELETE 내부에서 필요한 경우 서브쿼리 안에 WITH 포함 가능

  =====================================================================
  MERGE 문 규칙 (핵심)
  =====================================================================
  MERGE INTO tgt t
  USING (SELECT … FROM … WHERE …) s
  ON (t.id = s.id)
  WHEN MATCHED THEN
      UPDATE SET …
  WHEN NOT MATCHED THEN
      INSERT (…) VALUES (…);

  - USING 절은 반드시 괄호로 감싸고 별칭을 부여한다
  - ON 조건은 반드시 괄호로 감싼다

  =====================================================================
  제어 구조 (IF / LOOP / WHILE / FOR)
  =====================================================================
  - IF … THEN … ELSIF … ELSE … END IF;
  - LOOP … EXIT WHEN …; END LOOP;
  - WHILE condition LOOP … END LOOP;
  - FOR i IN n..m LOOP … END LOOP;
  - FOR rec IN (SELECT …) LOOP … END LOOP;

  =====================================================================
  예외 / 동적 SQL / 함수 매핑
  =====================================================================
  - RAISE EXCEPTION → RAISE_APPLICATION_ERROR(-20000, message)
  - NOTICE/INFO/WARNING → DBMS_OUTPUT.PUT_LINE
  - EXECUTE → EXECUTE IMMEDIATE
  - 주요 함수 매핑:
      SUBSTRING → SUBSTR
      LENGTH/CHAR_LENGTH → LENGTH
      NOW() → SYSDATE
      CURRENT_TIMESTAMP → SYSTIMESTAMP
      DATE_TRUNC → TRUNC
      STRING_AGG → LISTAGG WITHIN GROUP

  =====================================================================
  시퀀스
  =====================================================================
  - nextval('seq') → seq.NEXTVAL
  - currval('seq') → seq.CURRVAL

  =====================================================================
  안정성 규칙
  =====================================================================
  - 모든 SQL 문장 끝에 세미콜론 필수
  - 괄호 짝 정확히 맞출 것
  - 모든 서브쿼리는 별칭 필요
  - ORDER BY 없이 LIMIT/OFFSET이 있었다면 Oracle에서도 정렬 필요
  - 문자열·날짜·NULL 연산은 PostgreSQL과 동일한 결과 유지

  =====================================================================
  출력 형식
  =====================================================================
  {
    "code": "변환된 Oracle PL/SQL 본문 전체만 포함"
  }

  - parent_code는 절대 포함 금지
  - 주석, 설명, 추가 텍스트 금지
  - JSON 형식 준수
